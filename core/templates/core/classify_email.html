{% extends 'base.html' %}
{% load static %}

{% block title %}Classify Email{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h2 class="mb-4 text-center">Classify an Email</h2>

        <div class="form-group">
            <label for="emailText">Enter Email Content:</label>
            <textarea id="emailText" class="form-control" rows="8" placeholder="Paste email text here..."></textarea>
        </div>

        <button id="classifyButton" class="btn btn-primary btn-block">Classify</button>

        <div id="result" class="mt-4 text-center"></div>

        <div id="feedback" class="mt-3 text-center" style="display: none;">
            <p>Was this prediction accurate?</p>
            <button class="btn btn-sm btn-success mr-2" onclick="submitFeedback(true)">üëç Yes</button>
            <button class="btn btn-sm btn-danger" onclick="submitFeedback(false)">üëé No</button>
            
            <div class="form-group mt-3" id="userCommentGroup" style="display: none;">
                <label for="userComment">Optional: Your comments on the prediction:</label>
                <textarea id="userComment" class="form-control" rows="2" placeholder="e.g., 'This was actually ham' or 'Correctly identified!'"></textarea>
            </div>
            <div id="feedbackMessage" class="mt-2"></div>
        </div>
    </div>
</div>

<script>
    let classificationId = null;
    const classifyButton = document.getElementById('classifyButton');
    const emailTextarea = document.getElementById('emailText');
    const resultDiv = document.getElementById('result');
    const feedbackDiv = document.getElementById('feedback');
    const feedbackMessageDiv = document.getElementById('feedbackMessage');
    const userCommentGroup = document.getElementById('userCommentGroup');
    const userCommentTextarea = document.getElementById('userComment');

    // Show/hide comment box when feedback buttons are clicked
    feedbackDiv.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
            userCommentGroup.style.display = 'block';
        });
    });


    classifyButton.addEventListener('click', async () => {
        const emailText = emailTextarea.value.trim();

        resultDiv.innerHTML = '';
        feedbackDiv.style.display = 'none';
        feedbackMessageDiv.innerHTML = ''; // Clear previous feedback messages
        userCommentGroup.style.display = 'none'; // Hide comment box initially
        userCommentTextarea.value = ''; // Clear comment

        if (!emailText) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please enter email text.</div>';
            return;
        }

        classifyButton.disabled = true; // Disable button during classification
        resultDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Classifying...</div>'; // Added spinner

        try {
            const response = await fetch('/api/ml/predict/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ email_text: emailText })
            });

            const data = await response.json();

            if (response.ok) {
                classificationId = data.classification_id;
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Prediction:</strong> ${data.prediction.toUpperCase()}<br>
                        <strong>Confidence:</strong> ${(data.confidence * 100).toFixed(2)}%
                    </div>
                `;
                feedbackDiv.style.display = 'block';
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Something went wrong'}</div>`;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            resultDiv.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again later.</div>';
        } finally {
            classifyButton.disabled = false; // Re-enable button
        }
    });

    async function submitFeedback(isCorrect) {
        if (!classificationId) return;

        const userComment = userCommentTextarea.value.trim(); // Get comment

        // Disable feedback buttons to prevent double submission
        const feedbackButtons = feedbackDiv.querySelectorAll('button');
        feedbackButtons.forEach(button => button.disabled = true);
        feedbackMessageDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Submitting feedback...</div>'; // Added spinner

        try {
            const response = await fetch(`/core/feedback/${classificationId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    is_correct: isCorrect,
                    user_comment: userComment // Send the user comment
                })
            });

            const data = await response.json();

            if (response.ok) {
                feedbackMessageDiv.innerHTML = '<div class="alert alert-success">Thanks for your feedback!</div>';
                feedbackDiv.style.display = 'none'; // Hide feedback section after submission
                userCommentGroup.style.display = 'none'; // Also hide comment group
            } else {
                feedbackMessageDiv.innerHTML = `<div class="alert alert-warning">Feedback failed: ${data.message || data.error || JSON.stringify(data.errors)}. Try again.</div>`;
                feedbackButtons.forEach(button => button.disabled = false); // Re-enable on failure
            }
        } catch (error) {
            console.error('Feedback error:', error);
            feedbackMessageDiv.innerHTML = '<div class="alert alert-danger">An error occurred with feedback.</div>';
            feedbackButtons.forEach(button => button.disabled = false); // Re-enable on failure
        }
    }
</script>
{% endblock %}